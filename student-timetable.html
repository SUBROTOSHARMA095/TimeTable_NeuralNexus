<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Timetable</title>
  <style>
    /* Page + theme */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #f4f6f9, #dbe6f6);
      margin: 0;
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }

    /* Header container */
    .header-container {
      text-align: center;
      margin-bottom: 20px;
    }

    /* Main headings */
    h1 {
      margin-bottom: 10px;
      font-size: 32px;
      color: #007bff;
      font-weight: 700;
      letter-spacing: 0.5px;
      position: relative;
      display: inline-block;
      padding-bottom: 8px;
    }
    h1::after {
      content: "";
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 60%;
      height: 3px;
      background: #007bff;
      border-radius: 3px;
    }

    h2 {
      margin-top: 0;
      text-align: center;
      color: #444;
      font-size: 20px;
      margin-bottom: 25px;
    }

    h3 {
      margin-top: 18px;
      font-size: 18px;
      color: #0056b3;
      border-left: 5px solid #007bff;
      padding-left: 10px;
      display: inline-block;
    }

    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left: 4px solid #007bff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Container card */
    .timetable {
      margin: 20px auto;
      max-width: 900px;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .timetable::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #007bff, #0056b3, #007bff);
    }
    .timetable:hover { 
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    /* Day block wrapper */
    .day-block { 
      margin-bottom: 18px;
      transition: all 0.3s ease;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 15px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    th, td {
      border: 1px solid #e5e5e5;
      padding: 12px;
      text-align: center;
    }
    th {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: #fff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
    }
    tr:nth-child(even) { background: #f8fbff; }
    td {
      font-size: 14px;
      transition: background 0.3s ease, transform 0.2s ease;
      position: relative;
    }
    td:hover {
      background: #e8f1ff;
      transform: scale(1.02);
    }

    hr {
      border: 0;
      border-top: 1px dashed #bbb;
      margin: 6px 0;
    }

    /* No classes style */
    .no-shifts {
      margin: 8px 0 0 6px;
      color: #777;
      font-style: italic;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      display: inline-block;
    }

    /* Highlight current day */
    .highlight-day {
      position: relative;
    }
    .highlight-day::before {
      content: "Today";
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ffcc00;
      color: #333;
      font-size: 12px;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 12px;
      z-index: 1;
    }
    .highlight-day h3 {
      background: #fff6cc;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .highlight-day table {
      border: 2px solid #ffcc00;
      box-shadow: 0 0 8px rgba(255, 204, 0, 0.35);
    }

    /* Error message */
    .error-message {
      background: #ffe6e6;
      color: #d9534f;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
      border-left: 4px solid #d9534f;
    }

    /* Success message */
    .success-message {
      background: #e6ffe6;
      color: #28a745;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
      border-left: 4px solid #28a745;
    }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #777;
      font-size: 14px;
    }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      body { padding: 10px; }
      h1 { font-size: 24px; }
      .timetable { padding: 15px; }
      table { font-size: 13px; }
      th, td { padding: 8px; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 22px; }
      h2 { font-size: 18px; }
      h3 { font-size: 16px; }
      th, td { padding: 6px; font-size: 12px; }
      .timetable { padding: 10px; }
    }

    /* Animation for day blocks */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .day-block {
      animation: fadeIn 0.5s ease forwards;
    }
    
    /* Delay animations for each day */
    .day-block:nth-child(1) { animation-delay: 0.1s; }
    .day-block:nth-child(2) { animation-delay: 0.2s; }
    .day-block:nth-child(3) { animation-delay: 0.3s; }
    .day-block:nth-child(4) { animation-delay: 0.4s; }
    .day-block:nth-child(5) { animation-delay: 0.5s; }
  </style>
</head>
<body>
  <div class="header-container">
    <h1>My Timetable</h1>
  </div>
  
  <div id="timetableContainer" class="timetable" aria-live="polite">
    <div class="spinner"></div>
    <p style="text-align: center;">Loading your timetable...</p>
  </div>

  <div class="footer">
    <p>© 2023 Timetable Generator | Student Portal</p>
  </div>

  <script>
    // Helper to avoid HTML injection
    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      str = String(str);
      return str.replace(/[&<>"']/g, (m) => {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        }[m];
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const role = sessionStorage.getItem("role");
      const studentName = sessionStorage.getItem("studentName");
      const branch = sessionStorage.getItem("studentBranch");

      if (role !== "student" || !studentName || !branch) {
        document.getElementById("timetableContainer").innerHTML = `
          <div class="error-message">
            <p>No student login detected. Redirecting to login...</p>
          </div>
        `;
        setTimeout(() => window.location.href = "login.html", 1800);
        return;
      }

      // show loading
      document.getElementById("timetableContainer").innerHTML = `
        <div class="spinner" role="status" aria-hidden="true"></div>
        <p style="text-align:center;">Loading your timetable...</p>
      `;

      try {
        const res = await fetch("http://localhost:5000/get-saved-timetable");
        if (!res.ok) {
          throw new Error(`Server returned ${res.status}: ${res.statusText}`);
        }
        const data = await res.json();

        if (!data.timetable || !data.timetable[branch]) {
          document.getElementById("timetableContainer").innerHTML = `
            <div class="error-message">
              <p>No timetable found for branch: <b>${escapeHtml(branch)}</b></p>
              <p>Please contact your administrator.</p>
            </div>
          `;
          return;
        }

        const branchTimetable = data.timetable[branch];
        renderTimetable(studentName, branch, branchTimetable);

        // Highlight today's block if present
        const today = new Date().getDay(); // 0 = Sun, 1 = Mon ...
        if (today >= 1 && today <= 5) {
          const dayIndex = today - 1; // 0..4
          const selector = `.day-block[data-day-index="${dayIndex}"]`;
          const dayBlock = document.querySelector(selector);
          if (dayBlock) dayBlock.classList.add("highlight-day");
        }
      } catch (err) {
        console.error("Error fetching timetable:", err);
        document.getElementById("timetableContainer").innerHTML = `
          <div class="error-message">
            <p>Failed to load timetable. Please try again later.</p>
            <p><small>Error: ${escapeHtml(err.message)}</small></p>
          </div>
        `;
      }
    });

    /**
     * Render timetable for a branch.
     * Expected branchTimetable structure (two common shapes handled):
     * 1) Array-of-5-days: branchTimetable[dayIndex] = { "Section 1 Shift 1": [slot,...], ... }
     * 2) Object with day keys 0..4: same as above
     */
    function renderTimetable(studentName, branch, branchTimetable) {
      const container = document.getElementById("timetableContainer");
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

      let outParts = [];
      outParts.push(`<h2>Welcome ${escapeHtml(studentName)} (${escapeHtml(branch)})</h2>`);

      // normalize to array-of-days: try array first, otherwise build from numeric keys 0..4
      let daysArray = [];
      if (Array.isArray(branchTimetable)) {
        daysArray = branchTimetable;
      } else {
        // attempt to read numeric keys 0..4
        for (let i = 0; i < 5; i++) {
          if (branchTimetable.hasOwnProperty(i)) daysArray.push(branchTimetable[i]);
          else daysArray.push(branchTimetable[i] || {});
        }
      }

      daysArray.forEach((dayData, dIdx) => {
        // dayData should be an object mapping shiftName -> array-of-slots
        const safeDayData = dayData && typeof dayData === "object" ? dayData : {};
        outParts.push(`<div class="day-block" data-day-index="${dIdx}">`);
        outParts.push(`<h3>${escapeHtml(days[dIdx])}</h3>`);

        const shiftKeys = Object.keys(safeDayData || {});
        if (!shiftKeys.length) {
          outParts.push(`<div class="no-shifts">No classes scheduled</div>`);
        } else {
          outParts.push(`<table aria-label="${escapeHtml(days[dIdx])} timetable"><thead><tr><th>Shift</th><th>Periods</th></tr></thead><tbody>`);
          shiftKeys.forEach(shiftName => {
            const slotArray = safeDayData[shiftName];
            // defensive: slotArray may be an array (list of periods) or something else
            let periodsHtml = "";
            if (Array.isArray(slotArray)) {
              const cards = slotArray.map(slot => {
                // slot expected: [subject, faculty, room]
                if (!slot || !Array.isArray(slot)) {
                  return `<div class="period-card">—</div>`;
                }
                const subject = escapeHtml(slot[0] || "—");
                const teacher = escapeHtml(slot[1] || "");
                const room = escapeHtml(slot[2] || "");
                let extra = "";
                if (teacher) extra += `<div>${teacher}</div>`;
                if (room) extra += `<div><small>Room: ${room}</small></div>`;
                return `<div class="period-card"><strong>${subject}</strong>${extra}</div>`;
              });
              periodsHtml = cards.join("<hr>");
            } else {
              periodsHtml = "—";
            }

            outParts.push(`<tr><td style="width:160px"><strong>${escapeHtml(shiftName)}</strong></td><td>${periodsHtml}</td></tr>`);
          });
          outParts.push(`</tbody></table>`);
        }

        outParts.push(`</div>`); // day-block
      });

      container.innerHTML = outParts.join("");
    }
  </script>
</body>
</html>
 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Timetable</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #f4f6f9, #dbe6f6);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .header-container { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 32px; color: #007bff; margin: 0; }
    .timetable { margin: 20px auto; max-width: 900px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .day-block { margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #007bff; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    .section-select { display: block; margin: 0 auto 20px; padding: 8px; border-radius: 6px; border: 1px solid #bbb; font-size: 16px; }
  </style>
</head>
<body>
  <div class="header-container">
    <h1>My Timetable</h1>
        <select id="sectionSelect" class="section-select">
      <option value="">Select Section</option>
    </select>
  </div>
  
  <div id="timetableContainer" class="timetable" aria-live="polite">
    <p style="text-align: center;">Please select your section.</p>
  </div>

  <script>
  let allTimetableData = null; // Store the entire timetable JSON here
  let studentBranch = sessionStorage.getItem("studentBranch") || "CSE";
  let studentName = sessionStorage.getItem("studentName") || "Student";

  function escapeHtml(str) {
    if (!str) return "";
    return String(str).replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("http://localhost:5000/get-saved-timetable");
      const data = await res.json();
      allTimetableData = data.timetable;
      const branchTimetable = allTimetableData?.[studentBranch];

      if (!branchTimetable) {
        showError(`No timetable found for your branch: ${escapeHtml(studentBranch)}`);
        return;
      }

      // populate section dropdown with available sections for the student's branch
      const sectionSelect = document.getElementById("sectionSelect");
      Object.keys(branchTimetable).forEach(section => {
        sectionSelect.innerHTML += `<option value="${escapeHtml(section)}">${escapeHtml(section)}</option>`;
      });

      // listen to section selection
      sectionSelect.addEventListener("change", () => {
        const selectedSection = sectionSelect.value;
        if (selectedSection && branchTimetable[selectedSection]) {
          renderTimetable(selectedSection, branchTimetable[selectedSection]);
        } else {
          document.getElementById("timetableContainer").innerHTML = `<p style="text-align:center;">Please select your section.</p>`;
        }
      });

    } catch (err) {
      showError("Error loading timetable: " + escapeHtml(err.message));
    }
  });

  function renderTimetable(sectionName, sectionData) {
    const container = document.getElementById("timetableContainer");
    const schedule = sectionData.schedule;
    const days = Object.keys(schedule);
    const maxPeriods = Math.max(...days.map(day => schedule[day].length));

    let html = `<h2>Welcome ${escapeHtml(studentName)} (${escapeHtml(studentBranch)} - ${escapeHtml(sectionName)})</h2>`;
    html += `<h3>Shift: ${escapeHtml(sectionData.shift)}</h3>`;
    html += `<table>`;
    html += `<thead><tr><th>Period</th>`;
    days.forEach(day => { html += `<th>${escapeHtml(day)}</th>`; });
    html += `</tr></thead>`;
    html += `<tbody>`;

    for (let i = 0; i < maxPeriods; i++) {
      html += `<tr><td>${i + 1}</td>`;
      days.forEach(day => {
        const slot = schedule[day][i];
        if (slot) {
          html += `<td><strong>${escapeHtml(slot.subject)}</strong><br>${escapeHtml(slot.faculty)}<br><small>${escapeHtml(slot.room)}</small></td>`;
        } else {
          html += `<td>-</td>`;
        }
      });
      html += `</tr>`;
    }

    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  function showError(msg) {
    document.getElementById("timetableContainer").innerHTML = `<div style="color:red;padding:10px;">${msg}</div>`;
  }
  </script>
</body>
</html>